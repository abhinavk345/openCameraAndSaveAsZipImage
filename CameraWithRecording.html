<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Webcam Capture App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        video, canvas { border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-width: 100%; }
        .btn { margin-top: 10px; }
        .captured-img-container { position: relative; margin-bottom: 10px; }
        .captured-img { width: 100%; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .img-checkbox { position: absolute; top: 5px; left: 5px; transform: scale(1.5); z-index: 10; }
        .pagination { justify-content: center; }
    </style>
</head>
<body class="bg-light">

<div class="container py-4">
    <h1 class="text-center mb-4">Advanced Webcam App</h1>
    
    <div class="row justify-content-center">
        <div class="col-md-12 text-center">
            <!-- Video -->
            <div class="card p-3 mb-3 bg-white">
                <h5 class="card-title">Live Camera / Video</h5>
                <video id="video" width="640" height="480" autoplay></video>
                <div class="d-flex justify-content-center flex-wrap gap-2 mt-2">
                    <button id="captureBtn" class="btn btn-primary btn-lg">Capture Image</button>
                    <button id="switchCameraBtn" class="btn btn-warning btn-lg">Switch Camera</button>
                    <button id="startRecordingBtn" class="btn btn-danger btn-lg">Start Recording</button>
                    <button id="stopRecordingBtn" class="btn btn-success btn-lg">Stop Recording</button>
                    <button id="downloadPDFBtn" class="btn btn-info btn-lg">Export PDF</button>
                    <button id="createGIFBtn" class="btn btn-secondary btn-lg">Create GIF</button>
                    <button id="toggleAutoCaptureBtn" class="btn btn-dark btn-lg">Toggle Auto-Capture</button>
                </div>
            </div>

            <!-- Gallery -->
            <div class="card p-3 bg-white">
                <h5 class="card-title">Captured Images</h5>
                <div id="gallery" class="row g-2"></div>
                <nav>
                    <ul id="pagination" class="pagination mt-3"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>

<script>
    // Elements
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('captureBtn');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const startRecordingBtn = document.getElementById('startRecordingBtn');
    const stopRecordingBtn = document.getElementById('stopRecordingBtn');
    const downloadPDFBtn = document.getElementById('downloadPDFBtn');
    const createGIFBtn = document.getElementById('createGIFBtn');
    const toggleAutoCaptureBtn = document.getElementById('toggleAutoCaptureBtn');
    const gallery = document.getElementById('gallery');
    const paginationEl = document.getElementById('pagination');

    let capturedImages = [];
    let videoDevices = [];
    let currentDeviceIndex = 0;
    let stream = null;
    let mediaRecorder = null;
    let recordedChunks = [];
    let currentPage = 1;
    const imagesPerPage = 10;
    let autoCaptureInterval = null;

    // Load Face API models
    Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/')
    ]).then(() => console.log("Face API loaded"));

    // Get devices
    async function getVideoDevices() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        videoDevices = devices.filter(d => d.kind === 'videoinput');
    }

    async function startCamera(deviceId=null) {
        if (stream) stream.getTracks().forEach(t => t.stop());
        const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: true };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
    }

    async function init() {
        await getVideoDevices();
        currentDeviceIndex = 0;
        startCamera(videoDevices[currentDeviceIndex]?.deviceId);
    }

    // Capture image with optional face filter
    captureBtn.addEventListener('click', async () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Face Detection
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 3;
        detections.forEach(d => ctx.strokeRect(d.box.x, d.box.y, d.box.width, d.box.height));

        capturedImages.push({ dataURL: canvas.toDataURL('image/png'), selected: true });
        currentPage = Math.ceil(capturedImages.length / imagesPerPage);
        renderGallery(currentPage);
    });

    // Render gallery
    function renderGallery(page=1){
        gallery.innerHTML = '';
        const start = (page-1)*imagesPerPage;
        const end = Math.min(start + imagesPerPage, capturedImages.length);
        for(let i=start;i<end;i++){
            const col = document.createElement('div');
            col.className='col-1 captured-img-container';
            const img = document.createElement('img');
            img.src = capturedImages[i].dataURL;
            img.className='captured-img img-fluid';
            const checkbox = document.createElement('input');
            checkbox.type='checkbox';
            checkbox.checked = capturedImages[i].selected;
            checkbox.className='img-checkbox';
            checkbox.addEventListener('change', ()=> capturedImages[i].selected = checkbox.checked);
            col.appendChild(img);
            col.appendChild(checkbox);
            gallery.appendChild(col);
        }
        renderPagination();
    }

    function renderPagination(){
        paginationEl.innerHTML='';
        const totalPages = Math.ceil(capturedImages.length/imagesPerPage);
        if(totalPages<=1) return;
        for(let i=1;i<=totalPages;i++){
            const li=document.createElement('li');
            li.className=`page-item ${i===currentPage?'active':''}`;
            const a=document.createElement('a');
            a.className='page-link';
            a.href='#';
            a.innerText=i;
            a.addEventListener('click', e=>{
                e.preventDefault();
                currentPage=i;
                renderGallery(currentPage);
            });
            li.appendChild(a);
            paginationEl.appendChild(li);
        }
    }

    // Switch camera
    switchCameraBtn.addEventListener('click', () => {
        if(videoDevices.length<=1) return;
        currentDeviceIndex = (currentDeviceIndex +1)%videoDevices.length;
        startCamera(videoDevices[currentDeviceIndex].deviceId);
    });

    // Video Recording
    startRecordingBtn.addEventListener('click', () => {
        if(!stream) return;
        recordedChunks=[];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
        mediaRecorder.start();
        alert("Recording started");
    });

    stopRecordingBtn.addEventListener('click', () => {
        if(!mediaRecorder) return;
        mediaRecorder.stop();
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks,{type:'video/webm'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href=url;
            a.download='recording.webm';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
    });

    // PDF Export
    downloadPDFBtn.addEventListener('click', () => {
        if(capturedImages.length===0){ alert("No images"); return; }
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        capturedImages.forEach((img,i)=>{
            if(i>0) pdf.addPage();
            pdf.addImage(img.dataURL,'PNG',10,10,190,0);
        });
        pdf.save('images.pdf');
    });

    // GIF Creation
    createGIFBtn.addEventListener('click', () => {
        if(capturedImages.length===0){ alert("No images"); return; }
        const gif = new GIF({ workers:2, quality:10 });
        capturedImages.forEach(img=>{
            const tempImg = new Image();
            tempImg.src = img.dataURL;
            tempImg.onload = ()=> gif.addFrame(tempImg,{delay:500,copy:true});
        });
        gif.on('finished', blob=>{
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href=url;
            a.download='animation.gif';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        gif.render();
    });

    // Auto-capture every X seconds
    toggleAutoCaptureBtn.addEventListener('click', () => {
        if(autoCaptureInterval){
            clearInterval(autoCaptureInterval);
            autoCaptureInterval=null;
            toggleAutoCaptureBtn.innerText="Toggle Auto-Capture";
        } else {
            autoCaptureInterval = setInterval(()=> captureBtn.click(), 5000);
            toggleAutoCaptureBtn.innerText="Stop Auto-Capture";
        }
    });

    init();
</script>
</body>
</html>
